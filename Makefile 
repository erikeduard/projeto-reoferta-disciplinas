# Makefile para Projeto de OtimizaÃ§Ã£o de Reoferta de Disciplinas

.PHONY: help build up down logs clean test lint install dev prod

# VariÃ¡veis
COMPOSE_FILE = docker-compose.yml
PROJECT_NAME = reoferta-disciplinas

# Comando padrÃ£o
help: ## Mostra esta mensagem de ajuda
	@echo "Comandos disponÃ­veis:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# Comandos de desenvolvimento
dev: ## Inicia o ambiente de desenvolvimento
	@echo "ğŸš€ Iniciando ambiente de desenvolvimento..."
	docker-compose up --build

dev-bg: ## Inicia o ambiente de desenvolvimento em background
	@echo "ğŸš€ Iniciando ambiente de desenvolvimento em background..."
	docker-compose up --build -d
	@echo "âœ… ServiÃ§os iniciados. Acesse http://localhost"

# Comandos de produÃ§Ã£o
prod: ## Inicia o ambiente de produÃ§Ã£o
	@echo "ğŸ­ Iniciando ambiente de produÃ§Ã£o..."
	docker-compose -f $(COMPOSE_FILE) up --build -d
	@echo "âœ… Ambiente de produÃ§Ã£o iniciado"

# Comandos Docker bÃ¡sicos
build: ## ConstrÃ³i todas as imagens Docker
	@echo "ğŸ”¨ Construindo imagens Docker..."
	docker-compose build --no-cache

up: ## Inicia todos os serviÃ§os
	docker-compose up

up-bg: ## Inicia todos os serviÃ§os em background
	docker-compose up -d

down: ## Para todos os serviÃ§os
	@echo "â¹ï¸  Parando serviÃ§os..."
	docker-compose down

restart: ## Reinicia todos os serviÃ§os
	@echo "ğŸ”„ Reiniciando serviÃ§os..."
	docker-compose restart

# Comandos de logs
logs: ## Mostra logs de todos os serviÃ§os
	docker-compose logs -f

logs-api: ## Mostra logs apenas do backend
	docker-compose logs -f api

logs-frontend: ## Mostra logs apenas do frontend
	docker-compose logs -f frontend

logs-nginx: ## Mostra logs apenas do nginx
	docker-compose logs -f nginx

# Comandos de limpeza
clean: ## Remove containers parados e imagens nÃ£o utilizadas
	@echo "ğŸ§¹ Limpando containers e imagens..."
	docker-compose down
	docker system prune -f

clean-all: ## Remove tudo (CUIDADO: apaga volumes e dados)
	@echo "âš ï¸  ATENÃ‡ÃƒO: Este comando irÃ¡ apagar TODOS os dados!"
	@read -p "Tem certeza? Digite 'yes' para continuar: " confirm && [ "$$confirm" = "yes" ]
	docker-compose down -v
	docker system prune -af
	docker volume prune -f

# Comandos de teste
test: ## Executa testes no backend
	@echo "ğŸ§ª Executando testes..."
	docker-compose exec api npm test

test-coverage: ## Executa testes com coverage
	@echo "ğŸ§ª Executando testes com cobertura..."
	docker-compose exec api npm run test:coverage

# Comandos de lint
lint: ## Executa linting no cÃ³digo
	@echo "ğŸ” Verificando cÃ³digo..."
	docker-compose exec api npm run lint
	docker-compose exec frontend npm run lint

lint-fix: ## Corrige problemas de linting automaticamente
	@echo "ğŸ”§ Corrigindo cÃ³digo..."
	docker-compose exec api npm run lint:fix
	docker-compose exec frontend npm run lint:fix

# Comandos de banco de dados e volumes
backup: ## Cria backup dos dados
	@echo "ğŸ’¾ Criando backup..."
	mkdir -p backups
	docker run --rm -v $(PROJECT_NAME)_uploads:/data -v $(PWD)/backups:/backup alpine tar czf /backup/uploads-$(shell date +%Y%m%d_%H%M%S).tar.gz -C /data .
	docker run --rm -v $(PROJECT_NAME)_results:/data -v $(PWD)/backups:/backup alpine tar czf /backup/results-$(shell date +%Y%m%d_%H%M%S).tar.gz -C /data .

restore: ## Restaura backup dos dados (especifique BACKUP_FILE)
	@echo "ğŸ“‚ Restaurando backup..."
	@if [ -z "$(BACKUP_FILE)" ]; then echo "âŒ Especifique BACKUP_FILE=nome_do_arquivo"; exit 1; fi
	docker run --rm -v $(PROJECT_NAME)_uploads:/data -v $(PWD)/backups:/backup alpine tar xzf /backup/$(BACKUP_FILE) -C /data

# Comandos de debug
shell-api: ## Acessa shell do container do backend
	docker-compose exec api sh

shell-frontend: ## Acessa shell do container do frontend
	docker-compose exec frontend sh

shell-nginx: ## Acessa shell do container do nginx
	docker-compose exec nginx sh

# Comandos de informaÃ§Ã£o
status: ## Mostra status dos containers
	@echo "ğŸ“Š Status dos containers:"
	docker-compose ps

stats: ## Mostra estatÃ­sticas de uso dos containers
	@echo "ğŸ“ˆ EstatÃ­sticas de uso:"
	docker stats --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}"

health: ## Verifica saÃºde da aplicaÃ§Ã£o
	@echo "ğŸ¥ Verificando saÃºde da aplicaÃ§Ã£o..."
	@curl -f http://localhost/health || echo "âŒ AplicaÃ§Ã£o nÃ£o estÃ¡ respondendo"
	@curl -f http://localhost/api/health || echo "âŒ API nÃ£o estÃ¡ respondendo"

# Comandos de instalaÃ§Ã£o
install-deps: ## Instala dependÃªncias localmente (para desenvolvimento)
	@echo "ğŸ“¦ Instalando dependÃªncias do backend..."
	cd backend && npm install
	@echo "ğŸ“¦ Instalando dependÃªncias do frontend..."
	cd frontend && npm install

setup: ## ConfiguraÃ§Ã£o inicial do projeto
	@echo "âš™ï¸  Configurando projeto..."
	@if [ ! -f .env ]; then cp .env.example .env; echo "ğŸ“ Arquivo .env criado. Configure as variÃ¡veis necessÃ¡rias."; fi
	@mkdir -p backend/{uploads,results,logs}
	@mkdir -p backups
	@echo "âœ… Projeto configurado!"

# Comandos de deploy
deploy-staging: ## Deploy para ambiente de staging
	@echo "ğŸš€ Deploy para staging..."
	docker-compose -f docker-compose.yml -f docker-compose.staging.yml up --build -d

deploy-prod: ## Deploy para ambiente de produÃ§Ã£o
	@echo "ğŸš€ Deploy para produÃ§Ã£o..."
	docker-compose -f docker-compose.yml -f docker-compose.prod.yml up --build -d

# Comandos de monitoramento
monitor: ## Inicia monitoramento bÃ¡sico
	@echo "ğŸ“Š Iniciando monitoramento..."
	watch -n 5 'docker-compose ps && echo "" && docker stats --no-stream'

# Comandos de seguranÃ§a
security-scan: ## Executa scan de seguranÃ§a nas imagens
	@echo "ğŸ”’ Executando scan de seguranÃ§a..."
	docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image $(PROJECT_NAME)_api
	docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image $(PROJECT_NAME)_frontend

# Comandos de documentaÃ§Ã£o
docs: ## Gera documentaÃ§Ã£o da API
	@echo "ğŸ“š Gerando documentaÃ§Ã£o..."
	docker-compose exec api npm run docs

# Comandos Ãºteis para CI/CD
ci-build: ## Build para CI/CD
	docker-compose build

ci-test: ## Testes para CI/CD
	docker-compose run --rm api npm test
	docker-compose run --rm frontend npm test

ci-deploy: ## Deploy para CI/CD
	docker-compose up -d

# Exemplos de uso
example-upload: ## Exemplo de como fazer upload via API
	@echo "ğŸ“¤ Exemplo de upload:"
	@echo "curl -X POST -F 'planilha=@exemplo.xlsx' http://localhost/api/upload"

example-optimize: ## Exemplo de como executar otimizaÃ§Ã£o via API
	@echo "ğŸ§¬ Exemplo de otimizaÃ§Ã£o:"
	@echo 'curl -X POST -H "Content-Type: application/json" -d '"'"'{"filename":"arquivo.xlsx","parametros":{"maxDisciplinasReoferta":10}}'"'"' http://localhost/api/otimizar'

# InformaÃ§Ãµes do projeto
info: ## Mostra informaÃ§Ãµes do projeto
	@echo "â„¹ï¸  InformaÃ§Ãµes do Projeto:"
	@echo "Nome: $(PROJECT_NAME)"
	@echo "Frontend: http://localhost"
	@echo "API: http://localhost/api"
	@echo "Nginx: http://localhost"
	@echo ""
	@echo "ğŸ“ Estrutura de URLs:"
	@echo "  / - Frontend React"
	@echo "  /api - Backend API"
	@echo "  /health - Health check"